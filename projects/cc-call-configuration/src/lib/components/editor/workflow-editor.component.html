@if (viewModel) {
  <div style="display: flex; flex-direction: row; height: 100%; width: 100%;">
  <workflow-palette></workflow-palette>
    <div style="flex: 1; position: relative; display: flex; flex-direction: column;" (mousedown)="onCanvasClick()">
      <!-- Header for workflow name and ID -->
  <div style="padding: 12px 16px 4px 16px; background: #f5f5f5; border-bottom: 1px solid #e0e0e0; font-size: 1.1em; font-weight: 500; color: #333; position: relative; z-index: 1000;">
        @if (viewModel.workflow_name) {
          <span>{{ viewModel.workflow_name }}</span>
        }
        @if (viewModel.key) {
          <span style="color: #888; font-size: 0.95em; margin-left: 12px;">[ID: {{ viewModel.key }}]</span>
        }
      </div>
      <div style="flex: 1; position: relative;">
        <div style="position: relative; width: 100%; height: 100%;">
          <f-flow fDraggable [fFlowId]="viewModel.key"
                  (fLoaded)="onLoaded()"
                  (fCreateConnection)="onCreateConnection($event)"
                  (fReassignConnection)="onReassignConnection($event)">
            <f-background>
              <f-circle-pattern></f-circle-pattern>
            </f-background>
            <f-line-alignment></f-line-alignment>
            <f-selection-area></f-selection-area>
            <f-canvas fZoom>
              @for (connection of viewModel.connections; track connection.key) {
                <f-connection
                  [fBehavior]="cBehavior"
                  [fConnectionId]="connection.key"
                  [fOutputId]="connection.from"
                  [fInputId]="connection.to">
                </f-connection>
              }
              <f-connection-for-create [fType]="cType"></f-connection-for-create>
              @for (node of viewModel.nodes; track node.key) {
                <div
                  fNode
                  [fNodeId]="node.key"
                  [fNodePosition]="node.position"
                  (fNodePositionChange)="onNodePositionChanged($event, node)"
                  (dblclick)="$event.stopPropagation(); onNodeClick(node)">
                  <workflow-node
                    [model]="node"
                    [connections]="viewModel.connections"
                    (valueChange)="onValueChanged(node, $event)"
                    (removeConnection)="onRemoveConnection($event)">
                  </workflow-node>
                </div>
              }
            </f-canvas>
          </f-flow>
          <!-- Render arrowhead icons at the end of each connection using new Angular control flow -->
          <!-- Arrowhead icons manually rendered here previously have been removed. -->
        </div>
      </div>
    </div>
    <div style="width: 320px; height: 100%;">
      <workflow-sidebar
        [workflowName]="selectedNode ? (selectedNode.name || '') : (viewModel.workflow_name || '')"
        [workflowDescription]="selectedNode ? (selectedNode.description || '') : (viewModel.workflow_description || '')"
        [stepNodeId]="selectedNode?.key || null"
        [stepNode]="selectedNode"
        (deleteStep)="onDeleteStep($event)">
      </workflow-sidebar>
    </div>
  </div>
}
