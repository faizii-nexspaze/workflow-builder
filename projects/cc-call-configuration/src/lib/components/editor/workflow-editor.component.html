@if (viewModel) {
  <div style="display: flex; flex-direction: row; height: 100%; width: 100%;">
  <workflow-palette></workflow-palette>
    <div style="flex: 1; position: relative; display: flex; flex-direction: column;" (mousedown)="onCanvasClick()">
      <!-- Header for workflow name and ID -->
  <div style="padding: 12px 16px 4px 16px; background: #f5f5f5; border-bottom: 1px solid #e0e0e0; font-size: 1.1em; font-weight: 500; color: #333; position: relative; z-index: 1000;">
        @if (viewModel.workflow_name) {
          <span>{{ viewModel.workflow_name }}</span>
        }
        @if (viewModel.key) {
          <span style="color: #888; font-size: 0.95em; margin-left: 12px;">[ID: {{ viewModel.key }}]</span>
        }
      </div>
      <div style="flex: 1; position: relative;">
        <f-flow fDraggable [fFlowId]="viewModel.key"
                (fLoaded)="onLoaded()"
                (fCreateConnection)="onCreateConnection($event)"
                (fReassignConnection)="onReassignConnection($event)">
          <f-background>
            <f-circle-pattern></f-circle-pattern>
          </f-background>
          <f-line-alignment></f-line-alignment>
          <f-selection-area></f-selection-area>
          <f-canvas fZoom>
            @for (connection of viewModel.connections;track connection.key) {
              <f-connection [fBehavior]="cBehavior"
                            [fConnectionId]="connection.key"
                            [fType]="cType"
                            [fOutputId]="connection.from" [fInputId]="connection.to">
                <ng-container>
                  <svg id="normal_end_{{connection.key}}" viewBox="0 0 10 10" fMarker [type]="eMarkerType.END" [height]="10" [width]="10"
                       [refX]="10" [refY]="5" markerUnits="userSpaceOnUse" orient="auto">
                    <polygon points="0,0 10,5 0,10" fill="#888" />
                  </svg>
                  <svg id="selected_end_{{connection.key}}" viewBox="0 0 10 10" fMarker [type]="eMarkerType.SELECTED_END" [height]="10"
                       [width]="10" [refX]="10" [refY]="5" markerUnits="userSpaceOnUse" orient="auto">
                    <polygon points="0,0 10,5 0,10" fill="#1976d2" />
                  </svg>
                  @if (!!connection.name) {
                    <div fConnectionCenter>
                      {{ connection.name }}
                    </div>
                  }
                </ng-container>
              </f-connection>
            }
            <f-connection-for-create [fType]="cType">
              <svg id="normal_end" viewBox="0 0 10 10" fMarker [type]="eMarkerType.END" [height]="10" [width]="10" [refX]="10"
                   [refY]="5" markerUnits="userSpaceOnUse" orient="auto">
                <polygon points="0,0 10,5 0,10" fill="#888" />
              </svg>
            </f-connection-for-create>
            @for (node of viewModel.nodes;track node.key) {
              <div
                fNode
                [fNodeId]="node.key"
                [fNodePosition]="node.position"
                (fNodePositionChange)="onNodePositionChanged($event, node)"
                (dblclick)="$event.stopPropagation(); onNodeClick(node)">
                <workflow-node
                  [model]="node"
                  (valueChange)="onValueChanged(node, $event)"
                  (removeConnection)="onRemoveConnection($event)">
                </workflow-node>
              </div>
            }
          </f-canvas>
        </f-flow>
      </div>
    </div>
    <div style="width: 320px; height: 100%;">
      <workflow-sidebar
        [workflowName]="selectedNode ? (selectedNode.name || '') : (viewModel.workflow_name || '')"
        [workflowDescription]="selectedNode ? (selectedNode.description || '') : (viewModel.workflow_description || '')"
        [stepNodeId]="selectedNode?.key || null"
        (deleteStep)="onDeleteStep($event)">
      </workflow-sidebar>
    </div>
  </div>
}
